<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Virtual Assessment 360Â° - Tour</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.css" />

  <style>
    body { margin:0; font-family:sans-serif; }
    #container { display:flex; flex-wrap:wrap; height:100vh; }
    #panorama { flex:1 1 60%; min-width:300px; height:100%; }
    #map { flex:1 1 40%; min-width:300px; height:100%; }

    #pano-label {
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.6); color:white; padding:4px 10px; border-radius:4px;
      font-size:14px; z-index:999;
    }

    .legend {
      position:absolute;
      top:50px; right:10px;
      background:white;
      padding:8px;
      border:1px solid #ccc;
      border-radius:4px;
      max-height:70vh;
      overflow-y:auto;
      z-index:999;
    }
    .legend h4 { margin:0 0 5px 0; font-size:14px; }
    .legend ul { list-style:none; padding:0; margin:0; }
    .legend li { margin-bottom:4px; cursor:pointer; }

    .btn {
      background:white;
      border:1px solid #ccc;
      border-radius:4px;
      padding:4px 8px;
      cursor:pointer;
      margin-top:5px;
      display:block;
      font-size:13px;
    }

    @media (max-width:768px) {
      #container { flex-direction:column; }
      #panorama, #map { flex:1 1 100%; height:50%; }
    }

    /* --- Tambahan: geser search ke atas Daftar Isi --- */
    .leaflet-top.leaflet-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    .leaflet-control-geocoder {
      order: 0;
      margin-bottom: 5px;
    }
    #legendBtn {
      order: 1;
    }
  </style>
</head>
<body>
<div id="container">
  <div id="panorama"><div id="pano-label">Panorama</div></div>
  <div id="map"></div>
</div>

<!-- Pannellum -->
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />

<!-- Shapefile plugin -->
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>

<script>
  // ---------- Pannellum ----------
  var viewer = pannellum.viewer('panorama', {
    default: { firstScene:'sceneA', autoLoad:true },
    scenes: {
      "sceneA": { title:"A", type:"equirectangular", panorama:"foto360a.jpg", hfov:110 },
      "sceneB": { title:"B", type:"equirectangular", panorama:"foto360b.jpg", hfov:110 },
      "sceneC": { title:"C", type:"equirectangular", panorama:"foto360c.jpg", hfov:110 },
      "sceneD": { title:"D", type:"equirectangular", panorama:"foto360d.jpg", hfov:110 },
      "sceneE": { title:"E", type:"equirectangular", panorama:"foto360e.jpg", hfov:110 },
      "sceneF": { title:"F", type:"equirectangular", panorama:"foto360f.jpg", hfov:110 }
    }
  });
  var panoLabel = document.getElementById('pano-label');

  // ---------- Leaflet Map ----------
  var map = L.map('map',{fullscreenControl:true}).setView([0.7893, 101.3524], 10);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom:19, attribution:'Â© OpenStreetMap'
  }).addTo(map);

  L.Control.geocoder().addTo(map);
  L.control.locate().addTo(map);

  // shapefile (contoh batas kecamatan)
  shp("batas_kecamatan.zip").then(function(geojson){
    L.geoJSON(geojson,{style:{color:"#555",weight:1}}).addTo(map);
  });

  // ---------- Markers + linkage ----------
  var markerData = {
    a: { coords:[0.777833,101.400333], scene:'sceneA', name:'Pipa Air Well 5C-58', jenis:'BMN', pemilik:'PHR' },
    b: { coords:[1.255722,101.130778], scene:'sceneB', name:'BEKA25_0007', jenis:'SHM', pemilik:'Parhorasan' },
    c: { coords:[1.254083,101.132306], scene:'sceneC', name:'BEKA_#71', jenis:'SKGR', pemilik:'Robert' },
    d: { coords:[0.844583,101.385000], scene:'sceneD', name:'P_MINA25_0017HW', jenis:'SKT', pemilik:'Mesdi Br Sagala' },
    e: { coords:[0.703194,101.485667], scene:'sceneE', name:'9D-28E', jenis:'SHM', pemilik:'Tober Gultom' },
    f: { coords:[0.684500,101.111500], scene:'sceneF', name:'KB 500', jenis:'BMN', pemilik:'Tiara Dewi P' }
  };

  var markers = {};
  var iconDefault = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[28,28], iconAnchor:[14,28] });

  for (var k in markerData) {
    (function(key){
      var d = markerData[key];
      var m = L.marker(d.coords, {icon: iconDefault}).addTo(map)
        .bindPopup(
          "<b>" + d.name + "</b><br>" +
          "Koordinat: " + d.coords[0].toFixed(6) + ", " + d.coords[1].toFixed(6) + "<br>" +
          "Jenis Tanah: " + d.jenis + "<br>" +
          "Nama Pemilik: " + d.pemilik
        );
      m.on('click', function(){
        viewer.loadScene(d.scene);
        panoLabel.textContent = key.toUpperCase();
      });
      markers[key] = m;
    })(k);
  }

  // ---------- Legend/Daftar Isi ----------
  var legend = L.control({position:'topright'});
  legend.onAdd = function(map){
    var div = L.DomUtil.create('div','legend');
    div.innerHTML = "<h4>Daftar Isi</h4><ul>" +
      "<li onclick=\"jumpTo('a')\">A - Pipa Air Well 5C-58</li>" +
      "<li onclick=\"jumpTo('b')\">B - BEKA25_0007</li>" +
      "<li onclick=\"jumpTo('c')\">C - BEKA_#71</li>" +
      "<li onclick=\"jumpTo('d')\">D - P_MINA25_0017HW</li>" +
      "<li onclick=\"jumpTo('e')\">E - 9D-28E</li>" +
      "<li onclick=\"jumpTo('f')\">F - KB 500</li>" +
      "</ul>";
    return div;
  };
  function jumpTo(key){
    map.setView(markerData[key].coords,15);
    viewer.loadScene(markerData[key].scene);
    panoLabel.textContent = key.toUpperCase();
  }

  // Toggle button
  var legendBtn = L.control({position:'topright'});
  legendBtn.onAdd = function(){
    var btn = L.DomUtil.create('button','btn');
    btn.innerHTML = "ðŸ“‘ Daftar Isi";
    btn.onclick = function(){
      if (!map.hasControl(legend)) { legend.addTo(map); }
      else { map.removeControl(legend); }
    };
    return btn;
  };
  legendBtn.addTo(map);

  // klik luar untuk tutup
  map.on('click', function(){
    if (map.hasControl(legend)) { map.removeControl(legend); }
  });
</script>
</body>
</html>
